# Generated by Django 4.1 on 2025-09-10 01:17

from django.conf import settings
from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
        ('dormitory_repair', '0002_student_password_repairworker'),
    ]

    operations = [
        # 1. 首先添加新的user字段（允许null）
        migrations.AddField(
            model_name='repairorder',
            name='user',
            field=models.ForeignKey(null=True, on_delete=django.db.models.deletion.CASCADE, to=settings.AUTH_USER_MODEL, verbose_name='报修用户'),
        ),
        
        # 2. 数据迁移：将student的user_id复制到新的user字段
        migrations.RunSQL(
            "UPDATE dormitory_repair_repairorder SET user_id = (SELECT user_id FROM dormitory_repair_student WHERE dormitory_repair_student.id = dormitory_repair_repairorder.student_id) WHERE student_id IS NOT NULL;",
            reverse_sql="UPDATE dormitory_repair_repairorder SET student_id = (SELECT id FROM dormitory_repair_student WHERE dormitory_repair_student.user_id = dormitory_repair_repairorder.user_id) WHERE user_id IS NOT NULL;"
        ),
        
        # 3. 设置默认用户ID为1（admin）给没有关联学生的记录
        migrations.RunSQL(
            "UPDATE dormitory_repair_repairorder SET user_id = 1 WHERE user_id IS NULL;",
            reverse_sql="-- No reverse operation needed"
        ),
        
        # 4. 删除旧的student字段
        migrations.RemoveField(
            model_name='repairorder',
            name='student',
        ),
        
        # 5. 删除Student表
        migrations.DeleteModel(
            name='Student',
        ),
        
        # 6. 删除RepairWorker表
        migrations.DeleteModel(
            name='RepairWorker',
        ),
        
        # 7. 将user字段改为不允许null
        migrations.AlterField(
            model_name='repairorder',
            name='user',
            field=models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to=settings.AUTH_USER_MODEL, verbose_name='报修用户'),
        ),
    ]
